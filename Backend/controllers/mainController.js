const axios = require('axios');
const https = require('https');

const agent = new https.Agent({
    rejectUnauthorized: false
});



exports.getWebsite = async (req, res) => {
    try {
        const resp = await axios.get(req.query.url, {timeout: 2000, httpsAgent: agent});
        return res.status(resp.status).send(console.log(resp.status))
    } catch (error) {
        if (error.code == "ENOTFOUND") {
            return res.status(500).send(console.log("Something went wrong with the request."))
        } if (error.code == "ECONNABORTED") {
            return res.status(408).send(console.log("Request took too long."))
        } else {
            return res.status(error.response.status).send(console.log(error.response.status))
        }
    }
    
}

exports.getPHPInfo = (req,res) => {

    Promise.allSettled([
        axios.get(req.query.url + "/phpinfo.php", {timeout: 2000, httpsAgent: agent}),
        axios.get(req.query.url + "/test.php", {timeout: 2000, httpsAgent: agent}),
        axios.get(req.query.url + "/info.php", {timeout: 2000, httpsAgent: agent}),
        axios.get(req.query.url + "/phpinfo", {timeout: 2000, httpsAgent: agent}),

    ]).then((results) => {
        for (let index = 0; index < results.length; index++) {
            const result = results[index];
            if (result.value != undefined && result.value.status == 200 && result.value.data.match(/\WPHP Version\W/)) {
                return res.status(result.value.status).send(console.log(result.value.status + " " + result.value.config.url))
            }
             if (!results[index + 1]) {
                if (result.reason.code == "ENOTFOUND") {
                    return res.status(500).send(console.log("Something went wrong with the request.")) 
                } if (result.reason.code == "ECONNABORTED") {
                    return res.status(408).send(console.log("Request took too long."))
                } else {
                    return res.status(result.reason.response.status).send(console.log(result.reason.response.status + " " + result.reason.response.statusText))
                }
            }
            
        }
      })

}


exports.getGitConfig = (req, res) => {
    getRequest("/.git/config","core",req,res)
    
}

exports.getDockerCompose = (req, res) => {
    getRequest("/docker-compose.yml","version",req,res) 
}

exports.getLaravelLog = (req, res) => {
    getRequest("/storage/logs/laravel.log","laravel",req,res) 
}

async function getRequest(type,regex,req,res) {
        try {
            regex = new RegExp("\\W?"+regex+"\\W")
            const resp = await axios.get(req.query.url + type, {timeout: 2000, httpsAgent: agent});
            if (resp.data.match(regex) && resp.status == 200) {
                return res.status(resp.status).send(console.log(resp.status))
            }
            else {
                return res.status(404).send(console.log("Not found."))
            }
        } catch (error) {
            if (error.code == "ENOTFOUND") {
                return res.status(500).send(console.log("Something went wrong with the request.")) 
            } if (error.code == "ECONNABORTED") {
                return res.status(408).send(console.log("Request took too long."))
            } else {
                return res.status(error.response.status).send(console.log(error.response.status))
            }
        }
}