<template>
    <div class="row bg-light">
        <loading :active='isLoading' :is-full-page="fullPage" :loader='loader' :opacity="opacity" />
        <div class="col-lg-2"></div>
        <div class="col-lg-8">
            <h1 class="d-flex justify-content-center pt-4 pb-4">
                Vulnerability Scanner
            </h1>
            <div class="alert alert-warning alert-dismissible fade show d-flex align-items-center" role="alert">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                    class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" viewBox="0 0 16 16" role="img"
                    aria-label="Warning:">
                    <path
                        d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
                </svg>
                <div>
                    This website may or may not find every vulnerability affecting a website. To reduce the risk of a cyber
                    incident please practice good security practices (keeping your plugins up to date and restricting access
                    to
                    files that many contain critical information.).
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <form v-on:submit.prevent="sendRequest">
                <div class="mb-3 text-center">
                    <label for="exampleInputEmail1" class="form-label display-6">URL</label>
                    <p v-for="error of v$.$errors" :key="error.$uid">
                        <strong class="text-danger" v-if="error.$property == 'url'">{{
                            error.$message
                        }}</strong>
                    </p>
                    <div :class="errorClass" role="alert">
                        {{ errorMsg }}
                    </div>
                    <input type="text" class="form-control" id="exampleInputURL" aria-describedby="URLHelp"
                        placeholder="https://example.com/" v-model="url">
                    <div id="URLHelp" class="form-text"> Urls must contain either HTTP or HTTPS protocol.</div>
                </div>
                <div class="accordion mt-3" id="accordionExample">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                Scan options
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
                            data-bs-parent="#accordionExample">
                            <div class="accordion-body">
                                <div class="mb-3 row">
                                    <label for="inputTimeout" class="col-sm-2 col-form-label">Timeout</label>
                                    <div class="col-sm-10">
                                        <p v-for="error of v$.$errors" :key="error.$uid">
                                            <strong class="text-danger" v-if="error.$property == 'timeout'">{{
                                                error.$message
                                            }}</strong>
                                        </p>
                                        <input type="number" class="form-control" id="inputTimeout"
                                            aria-describedby="timeoutHelp" v-model="timeout">
                                        <div id="timeoutHelp" class="form-text">Timeout cancels a get request if the
                                            request takes longer than the timeout value. If the results come back
                                            inconclusive
                                            we
                                            suggest you run the scanner again with a longer timeout.
                                        </div>
                                    </div>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="inlineCheckbox1" value="option1"
                                        checked v-model="standardVuln">
                                    <label class="form-check-label" for="inlineCheckbox1">Standard vulnerabilities</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="inlineCheckbox2" value="option2"
                                        checked v-model="wpVuln">
                                    <label class="form-check-label" for="inlineCheckbox2">WordPress vulnerabilities</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="inlineCheckbox3" value="option3"
                                        checked v-model="joomlaVuln">
                                    <label class="form-check-label" for="inlineCheckbox3">Joomla! vulnerabilities</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="inlineCheckbox4" value="option4"
                                        checked v-model="backupVuln">
                                    <label class="form-check-label" for="inlineCheckbox4">Backup exposure
                                        vulnerabilities</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="inlineCheckbox5" value="option5"
                                        checked v-model="phpVuln">
                                    <label class="form-check-label" for="inlineCheckbox5">PHP vulnerabilities</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="text-align: center;">
                    <button type="submit" class="btn btn-primary mt-3">Submit</button>
                </div>
            </form>
            <div v-if="responseData.length > 0" class="card-group mt-3" v-for="row in formatResponses" :key="row.id">
                <div class="card" v-for="request in row" :key="request.id">
                    <div class="card-body">
                        <h3 class="card-title text-center">{{ request.statusCode }}</h3>
                        <h5 class="card-text text-center mt-3">{{ request.statusText }}</h5>
                        <div class="text-center"> <a v-bind:href="request.url" class="card-text mt-4">Visit location of
                                vulnerability.</a></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-2"></div>
    </div>
</template>

<script>
import axios from "axios";
import { useVuelidate } from "@vuelidate/core";
import { required, minValue, maxValue } from "@vuelidate/validators";
import Loading from 'vue-loading-overlay';
import 'vue-loading-overlay/dist/css/index.css';
export default {
    setup() {
        return { v$: useVuelidate() }
    },
    components: {
        Loading
    },
    data() {
        return {
            responseData: [],
            url: "",
            timeout: "4",
            standardVuln: true,
            wpVuln: true,
            joomlaVuln: true,
            backupVuln: true,
            phpVuln: true,
            errorMsg: "",
            errorClass: "alert alert-danger d-none",
            selectedVulns: [],
            standardVulnList: ["/gitconfig", "/dockercompose", "/apachestatus", "/lfigen"],
            wpVulnList: ["/wpdebuglog", "/wpconfig", "/lfidupe", "/errorlog", "/wplogin",],
            joomlaVulnList: ["/jckeditor", "/joomlaconfig"],
            backupVulnList: ["/sqldump", "/backup"],
            phpVulnList: ["/phpinfo", "/phpmyadmin", "/symfony", "/laravellog",],
            requests: [],
            isLoading: false,
            fullPage: false,
            loader: "spinner",
            opacity: 0.5,
        };
    },
    validations: {
        url: {
            required,
        },
        timeout: {
            required,
            minValue: minValue(1),
            maxValue: maxValue(15),

        },
    },
    methods: {
        async sendRequest() {
            const isFormValid = await this.v$.$validate();
            if (isFormValid == true) {
                if (this.standardVuln == false && this.wpVuln == false && this.joomlaVuln == false && this.backupVuln == false && this.phpVuln == false) {
                    this.errorMsg = "At least one type of test has to be selected to continue.";
                    this.errorClass = "alert alert-danger";
                }
                else if (this.url == window.location.href || this.url == location.protocol + "//" + location.host + "/") { // if this check is not here the application will throw a error message. This was the only reasonable fix
                    this.errorMsg = "Scanning the scanner is prohibited!";
                    this.errorClass = "alert alert-danger";
                }
                else {
                    if (this.isUrlValid(this.url)) {
                        this.selectedVulns = [] // Clearing out previous scans selected Vulnerabilities.
                        this.responseData = [] // Clearing out previous scans responses.
                        this.requests = [] // Clearing out previous scans urls to request.
                        this.errorMsg = "";
                        this.errorClass = "alert alert-danger d-none";
                        if (this.standardVuln == true) {
                            this.selectedVulns = this.selectedVulns.concat(this.standardVulnList);
                        }
                        if (this.wpVuln == true) {
                            this.selectedVulns = this.selectedVulns.concat(this.wpVulnList);
                        }
                        if (this.joomlaVuln == true) {
                            this.selectedVulns = this.selectedVulns.concat(this.joomlaVulnList);
                        }
                        if (this.backupVuln == true) {
                            this.selectedVulns = this.selectedVulns.concat(this.backupVulnList);
                        }
                        if (this.phpVuln == true) {
                            this.selectedVulns = this.selectedVulns.concat(this.phpVulnList);
                        }
                        this.isLoading = true;
                        for (let index = 0; index < this.selectedVulns.length; index++) {
                            const vuln = this.selectedVulns[index];
                            this.requests.push(axios.get("http://localhost:3000" + vuln + "?url=" + this.url + "&timeout=" + this.timeout + "000"))
                        }
                        Promise.allSettled(this.requests)
                            .then((results) => {
                                results.forEach(result => {
                                    if (result.status == "fulfilled") {
                                        this.responseData.push(result.value.data)
                                    }
                                    else if (result.status == "rejected") {
                                        this.responseData.push(result.reason.response.data)
                                    }
                                    this.isLoading = false
                                });
                                console.log(this.responseData);
                            });
                    }
                    else {
                        this.errorMsg = "The entered url is invalid.";
                        this.errorClass = "alert alert-danger";
                    }
                }
            }
            else {
                console.log("error");
            }
        },
        isUrlValid(url) {
            var urlChecker = document.createElement('input');
            urlChecker.type = 'url';
            urlChecker.value = url;

            if (!urlChecker.checkValidity()) {
                return false;
            } else {
                return true;
            }
        },
    },
    computed: {
        formatResponses() {
            return this.responseData.reduce((c, n, i) => {
                if (i % 4 === 0) c.push([]);
                c[c.length - 1].push(n);
                return c;
            }, []);
        },
    },
}
</script>